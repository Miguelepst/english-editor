# 1. EL NOMBRE DEL ROBOT ğŸ¤–
# Este es el tÃ­tulo que verÃ¡s en la pestaÃ±a "Actions" de tu GitHub.
name: ğŸ›¡ï¸ Pipeline de DevSecOps

# 2. LOS GATILLOS (Â¿CuÃ¡ndo se despierta la mÃ¡quina?) â°
# "on" significa "encendido" o "al ocurrir esto".
on:
  push:
    branches: [ "main" ] # DespiÃ©rtate cada vez que yo suba cÃ³digo nuevo a la rama principal ("main").
  pull_request:
    branches: [ "main" ] # DespiÃ©rtate si alguien intenta mezclar cÃ³digo nuevo hacia "main".

# 3. EL TRABAJO A REALIZAR ğŸ‘·
jobs:
  ejecutar_pruebas_seguridad:

    # Â¿QUÃ‰ COMPUTADORA USAMOS? ğŸ’»
    # Le pedimos a GitHub que nos preste un servidor con la Ãºltima versiÃ³n de Linux Ubuntu.
    runs-on: ubuntu-latest

    # 4. EL PASO A PASO (La receta) ğŸ“‹
    steps:

      # Paso 1: Por defecto, el servidor prestado estÃ¡ vacÃ­o.
      # Usamos una acciÃ³n prefabricada de GitHub (checkout) para clonar tu cÃ³digo allÃ­.
      - name: ğŸ“¥ Descargar el cÃ³digo de english-editor
        uses: actions/checkout@v4

      # Paso 2: El servidor necesita tener Python instalado para entender tu cÃ³digo.
      - name: ğŸ Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10" # Preparamos Python 3.10

      # Paso 3: Instalar las herramientas de Application Security Testing (AST).
      # "run" nos permite escribir comandos de terminal exactos como los usarÃ­as en Colab.
      - name: ğŸ› ï¸ Instalar herramientas (SAST, SCA, Secretos)
        run: |
          # 1. Instalamos Bandit (AnÃ¡lisis estÃ¡tico) y pip-licenses
          pip install bandit pip-licenses

          # 2. Descargamos e instalamos Gitleaks (Para encontrar secretos expuestos)
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.2_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/

          # 3. Instalamos Trivy (Para revisar vulnerabilidades de dependencias)
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      # Paso 4: Â¡La gran final!
      # Ejecutamos tu orquestador. Nota que la ruta apunta a donde tu plantilla Python lo guardÃ³.
      - name: ğŸš€ Ejecutar el Orquestador DevSecOps
        run: python src/english_editor/infrastructure/devsecops/devsecops_orchestrator.py
